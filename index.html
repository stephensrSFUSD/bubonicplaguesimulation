
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plague Survivor: A Medieval Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #2c1810 0%, #4a2c1a 100%);
            color: #f4e4c1;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(30, 20, 10, 0.9);
            border: 3px solid #8b6914;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
        }

        h1 {
            text-align: center;
            color: #d4af37;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .subtitle {
            text-align: center;
            font-style: italic;
            margin-bottom: 30px;
            color: #c9a961;
        }

        .character-sheet {
            background: rgba(60, 40, 20, 0.6);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .stat-row {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .stat {
            background: rgba(40, 25, 10, 0.8);
            padding: 12px 20px;
            border-radius: 5px;
            border: 1px solid #654321;
            text-align: center;
            min-width: 140px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #c9a961;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #d4af37;
        }

        .health-bar {
            width: 100%;
            height: 25px;
            background: #331a0a;
            border: 2px solid #654321;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #c41e3a 0%, #e63946 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .story-box {
            background: rgba(50, 35, 20, 0.8);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            line-height: 1.8;
            font-size: 1.1em;
        }

        .location-header {
            font-size: 1.5em;
            color: #d4af37;
            margin-bottom: 15px;
            border-bottom: 2px solid #654321;
            padding-bottom: 10px;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .choice-btn {
            background: linear-gradient(135deg, #654321 0%, #8b6914 100%);
            color: #f4e4c1;
            border: 2px solid #d4af37;
            padding: 18px 25px;
            font-size: 1.05em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-family: 'Georgia', serif;
        }

        .choice-btn:hover {
            background: linear-gradient(135deg, #8b6914 0%, #a67c1b 100%);
            border-color: #f4e4c1;
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .outcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .outcome-content {
            background: rgba(40, 25, 10, 0.95);
            border: 3px solid #d4af37;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .outcome-header {
            font-size: 1.8em;
            color: #d4af37;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #654321;
            padding-bottom: 10px;
        }

        .outcome-text {
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 25px;
            color: #f4e4c1;
        }

        .dice-result {
            font-size: 2.5em;
            color: #d4af37;
            margin: 20px 0;
            text-align: center;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }

        .continue-btn {
            background: linear-gradient(135deg, #1a4d1a 0%, #2d7a2d 100%);
            color: white;
            border: 2px solid #4a9d4a;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-family: 'Georgia', serif;
            font-weight: bold;
        }

        .continue-btn:hover {
            background: linear-gradient(135deg, #2d7a2d 0%, #3d9a3d 100%);
        }

        .dice-rolling-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
            margin: 20px 0;
        }

        .dice-spinner {
            font-size: 5em;
            animation: spin 0.5s linear infinite;
            filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.6));
        }

        @keyframes spin {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.2); }
            50% { transform: rotate(180deg) scale(1); }
            75% { transform: rotate(270deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: rgba(30, 20, 10, 0.8);
            border: 2px solid #8b6914;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #d4af37 0%, #f4e4c1 50%, #d4af37 100%);
            border-radius: 15px;
            transition: width 0.05s linear;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.8);
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 1s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .game-over {
            text-align: center;
            padding: 30px;
        }

        .game-over h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #d4af37;
        }

        .restart-btn {
            background: linear-gradient(135deg, #1a4d1a 0%, #2d7a2d 100%);
            color: white;
            border: 2px solid #4a9d4a;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-family: 'Georgia', serif;
        }

        .restart-btn:hover {
            background: linear-gradient(135deg, #2d7a2d 0%, #3d9a3d 100%);
        }

        .knowledge-box {
            background: rgba(20, 40, 60, 0.7);
            border: 2px solid #4a7ba7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #6a9bcf;
        }

        .knowledge-box h3 {
            color: #6a9bcf;
            margin-bottom: 10px;
        }

        .inventory {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .item {
            background: rgba(80, 60, 40, 0.8);
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #8b6914;
            font-size: 0.95em;
        }

        .clickable-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clickable-item:hover {
            background: rgba(212, 175, 55, 0.5);
            border-color: #d4af37;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(212, 175, 55, 0.4);
        }

        .clickable-item:active {
            transform: translateY(0px);
        }

        /* Character Creation Styles */
        .character-creation {
            background: rgba(50, 35, 20, 0.8);
            border: 2px solid #8b6914;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .creation-section {
            margin-bottom: 25px;
        }

        .creation-section h3 {
            color: #d4af37;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .name-input {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #8b6914;
            border-radius: 5px;
            background: rgba(30, 20, 10, 0.8);
            color: #f4e4c1;
            font-family: 'Georgia', serif;
        }

        .name-input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .stat-allocation {
            display: grid;
            gap: 20px;
        }

        .stat-control {
            background: rgba(40, 25, 10, 0.8);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #654321;
        }

        .stat-control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-name {
            font-weight: bold;
            color: #d4af37;
            font-size: 1.1em;
        }

        .stat-buttons {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-btn {
            background: linear-gradient(135deg, #654321 0%, #8b6914 100%);
            color: #f4e4c1;
            border: 2px solid #d4af37;
            width: 40px;
            height: 40px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stat-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #8b6914 0%, #a67c1b 100%);
            transform: scale(1.1);
        }

        .stat-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .stat-current {
            font-size: 1.5em;
            font-weight: bold;
            color: #d4af37;
            min-width: 30px;
            text-align: center;
        }

        .stat-description {
            color: #c9a961;
            font-size: 0.95em;
            line-height: 1.5;
            margin-top: 5px;
        }

        .points-remaining {
            background: rgba(100, 50, 20, 0.8);
            border: 2px solid #d4af37;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .points-remaining-number {
            font-size: 3em;
            color: #d4af37;
            font-weight: bold;
        }

        .start-btn {
            background: linear-gradient(135deg, #1a4d1a 0%, #2d7a2d 100%);
            color: white;
            border: 2px solid #4a9d4a;
            padding: 18px 40px;
            font-size: 1.3em;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-family: 'Georgia', serif;
            font-weight: bold;
        }

        .start-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #2d7a2d 0%, #3d9a3d 100%);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .stat-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öîÔ∏è Plague Survivor ‚öîÔ∏è</h1>
        <p class="subtitle">A Medieval Adventure Through the Black Death</p>
        
        <div id="characterSheet" class="character-sheet" style="display: none;">
            <!-- Character sheet will be populated -->
        </div>

        <div id="storyContent" class="story-box">
            <!-- Story content will be inserted here -->
        </div>

        <div id="choicesContainer" class="choices">
            <!-- Choices will be inserted here -->
        </div>
    </div>

    <!-- Outcome Modal -->
    <div id="outcomeModal" style="display: none;">
        <!-- Modal content will be inserted here -->
    </div>

    <script>
        // Game State
        let gameState = {
            characterName: '',
            health: 100,
            maxHealth: 100,
            gold: 50,
            townsVisited: 0,
            inventory: ['Travel Cloak', 'Water Flask'],
            wisdom: 0,
            strength: 0,
            luck: 0,
            charisma: 0,
            hasVinegar: false,
            hasHerbs: false,
            hasMask: false,
            hasInfo: false,
            avoidedSickPeople: false,
            cleanedHands: false,
            stayedClean: false,
            helpedOthers: 0,
            peopleTalkedTo: 0,
            currentLocation: 0,
            gameStarted: false
        };

        // Character creation
        let creationState = {
            pointsRemaining: 10,
            stats: {
                wisdom: 0,
                strength: 0,
                luck: 0,
                charisma: 0
            }
        };

        // Story locations - SHORTENED TEXT, MORE NPC INTERACTIONS, HARDER CONSEQUENCES
        const storyPath = [
            {
                name: "The Journey Begins - Your Village (1347)",
                text: "You live in a small Italian village. News arrives: a terrible plague is spreading from the East, killing people within days. Dark swellings appear on victims' bodies. Your village elder warns it may reach here soon.",
                knowledge: "The Black Death arrived in Europe in 1347 on trading ships from Asia. The disease was caused by bacteria carried by fleas on rats. Medieval people did not know about germs.",
                choices: [
                    {
                        text: "üß† Travel to find safety (Wisdom check)",
                        diceRoll: true,
                        difficulty: 10,
                        success: () => {
                            gameState.gold += 10;
                            return "You prepared well and found supplies on the road!";
                        },
                        failure: () => {
                            gameState.health -= 20;
                            gameState.gold -= 10;
                            return "The journey was rough. You got lost, lost supplies, and exhausted yourself.";
                        },
                        nextLocation: 1
                    },
                    {
                        text: "üçÄ Stay and hope the plague doesn't come (Risky gamble)",
                        diceRoll: true,
                        difficulty: 18,
                        success: () => {
                            gameState.gold += 20;
                            return "Incredibly lucky! The plague never reached your village. You had time to prepare and leave with extra supplies!";
                        },
                        failure: () => {
                            gameState.health -= 50;
                            return "TERRIBLE LUCK! The plague reached your village within weeks! Rats infested your home and their fleas bit you repeatedly. You got very sick.";
                        },
                        nextLocation: 1
                    },
                    {
                        text: "üçÄ Buy extra supplies before leaving (Risky gamble - Costs 15 gold)",
                        goldCost: 15,
                        diceRoll: true,
                        difficulty: 12,
                        success: () => {
                            gameState.inventory.push('Medicine Pouch');
                            gameState.health += 5;
                            return "Lucky! You found a trustworthy merchant and got quality supplies.";
                        },
                        failure: () => {
                            gameState.health -= 10;
                            return "While shopping, you walked through rat-infested market stalls. Fleas bit you multiple times.";
                        },
                        nextLocation: 1
                    }
                ]
            },
            {
                name: "Genoa - The Port City",
                text: "Genoa is crowded with sick merchants and sailors. A doctor in a bird-mask walks by. Rats run through dirty streets.",
                knowledge: "Medieval cities attracted rats with garbage in streets. Rats carried fleas that spread plague bacteria. Doctors wore bird-beak masks filled with herbs because they thought bad smells caused disease.",
                choices: [
                    {
                        text: "üß† Avoid crowds, find food on outskirts (Wisdom check)",
                        diceRoll: true,
                        difficulty: 12,
                        success: () => {
                            gameState.avoidedSickPeople = true;
                            return "Smart! You stayed away from dangerous areas and found clean food.";
                        },
                        failure: () => {
                            gameState.health -= 25;
                            return "You got lost in a crowded, sick area full of rats and fleas. You were bitten multiple times by fleas.";
                        },
                        nextLocation: 2
                    },
                    {
                        text: "üçÄ Buy herb mask from merchant (Risky gamble - Costs 20 gold)",
                        goldCost: 20,
                        diceRoll: true,
                        difficulty: 14,
                        success: () => {
                            gameState.hasMask = true;
                            gameState.inventory.push('Herb Mask');
                            return "Good quality mask! Medieval people thought herbs protected against 'bad air.'";
                        },
                        failure: () => {
                            gameState.health -= 20;
                            return "The merchant sold you a fake mask. You wore it confidently and walked through rat-infested areas. Fleas bit you!";
                        },
                        nextLocation: 2
                    },
                    {
                        text: "üß† Observe Merchant Antonio to judge if he's trustworthy (Wisdom check)",
                        diceRoll: true,
                        difficulty: 13,
                        success: () => {
                            gameState.peopleTalkedTo++;
                            gameState.hasInfo = true;
                            gameState.inventory.push('Travel Map');
                            return "You correctly read Antonio's body language! He gives you honest advice: 'Avoid Venice‚Äîplague is terrible there. Head for countryside!'";
                        },
                        failure: () => {
                            gameState.peopleTalkedTo++;
                            gameState.gold -= 15;
                            gameState.health -= 15;
                            return "You misjudged Antonio! He gave you FALSE directions that led through rat-infested alleys where fleas bit you, and he picked your pocket!";
                        },
                        nextLocation: 2
                    },
                    {
                        text: "üí™ Work loading ships at the docks (Strength check)",
                        diceRoll: true,
                        difficulty: 13,
                        success: () => {
                            const totalGold = 25 + (gameState.strength * 5);
                            gameState.gold += totalGold;
                            return gameState.strength > 0 ?
                                `Your strength impresses the dock master! You earned ${totalGold} gold. (+${gameState.strength * 5} strength bonus)` :
                                `Hard work but you earned ${totalGold} gold safely.`;
                        },
                        failure: () => {
                            const healthLoss = Math.max(20, 35 - gameState.strength * 3);
                            gameState.health -= healthLoss;
                            return `The cargo came from plague ships! Rats ran everywhere and fleas bit you while working. (Lost ${healthLoss} health)`;
                        },
                        nextLocation: 2
                    },
                    {
                        text: "üçÄ Sleep in cheap inn near docks (Risky gamble - Costs 10 gold)",
                        goldCost: 10,
                        diceRoll: true,
                        difficulty: 17,
                        success: () => {
                            gameState.health += 5;
                            return "You avoided sick guests. You feel rested.";
                        },
                        failure: () => {
                            gameState.health -= 30;
                            return "DISASTER! The inn was packed with dying sailors. You slept in a room where someone died of plague last night. The bedding was full of fleas that bit you all night!";
                        },
                        nextLocation: 2
                    },
                    {
                        text: "üõí Visit the merchant's stall",
                        special: 'shop'
                    }
                ]
            },
            {
                name: "Countryside Village",
                text: "A small farming village. Families have fled. Sick people lie in streets with fever. The priest preaches that prayer will protect them. A farmer claims isolation keeps his family safe.",
                knowledge: "About one-third of all Europeans died from the Black Death (1347-1353)‚Äîabout 25 million people! People didn't understand that fleas and rats spread the disease.",
                choices: [
                    {
                        text: "üçÄ Buy vinegar to wash hands (Risky gamble - Costs 15 gold)",
                        goldCost: 15,
                        diceRoll: true,
                        difficulty: 11,
                        success: () => {
                            gameState.hasVinegar = true;
                            gameState.cleanedHands = true;
                            gameState.inventory.push('Vinegar');
                            return "Good choice! Vinegar kills some germs. Medieval people noticed staying clean helped.";
                        },
                        failure: () => {
                            gameState.health -= 10;
                            return "You bought vinegar but it was mostly water. Doesn't help much.";
                        },
                        nextLocation: 3
                    },
                    {
                        text: "üçÄ Help sick villagers (Very risky - Health check)",
                        diceRoll: true,
                        difficulty: 18,
                        success: () => {
                            gameState.helpedOthers++;
                            const totalGold = 15 + (gameState.charisma * 3);
                            gameState.gold += totalGold;
                            return gameState.charisma > 0 ?
                                `You helped from a distance with great care. Grateful villagers gave you ${totalGold} gold! (+${gameState.charisma * 3} charisma)` :
                                `You helped very carefully from a distance. Villagers gave you ${totalGold} gold.`;
                        },
                        failure: () => {
                            const healthLoss = Math.max(30, 45 - gameState.strength * 3);
                            gameState.health -= healthLoss;
                            return `DANGEROUS! You got too close to dying plague victims. Their belongings were infested with fleas that bit you repeatedly. You feel very feverish. (Lost ${healthLoss} health)`;
                        },
                        nextLocation: 3
                    },
                    {
                        text: "üß† Avoid village entirely (Wisdom check)",
                        diceRoll: true,
                        difficulty: 10,
                        success: () => {
                            return "Smart! You stayed far away. Isolation was one of the few things that worked.";
                        },
                        failure: () => {
                            gameState.health -= 20;
                            return "Sick people blocked the road and begged for help. You had to push through them. Fleas from their clothing jumped onto you and bit you.";
                        },
                        nextLocation: 3
                    },
                    {
                        text: "üí™ Intimidate Father Marco into giving you supplies (Strength check)",
                        diceRoll: true,
                        difficulty: 14,
                        success: () => {
                            gameState.peopleTalkedTo++;
                            gameState.gold += 20;
                            gameState.hasInfo = true;
                            return "Your physical presence intimidated Father Marco! He gave you money and told you which towns to avoid to get rid of you.";
                        },
                        failure: () => {
                            gameState.peopleTalkedTo++;
                            gameState.gold -= 15;
                            gameState.health -= 15;
                            return "Father Marco called the villagers to defend him! They beat you and chased you through rat-filled streets. Fleas bit you while you escaped!";
                        },
                        nextLocation: 3
                    },
                    {
                        text: "üõí Visit traveling merchant's cart",
                        special: 'shop'
                    }
                ]
            },
            {
                name: "Florence - The Walled City",
                text: "Florence has tall walls. Guards check everyone for sickness at the gate. Streets are cleaner‚Äîleaders ordered garbage removal. Still, sick people are taken to plague houses daily.",
                knowledge: "Some cities tried quarantine‚Äîclosing gates to sick people. The word comes from Italian meaning '40 days' because ships waited 40 days before entering. This slowed but didn't stop plague.",
                choices: [
                    {
                        text: "Stay in clean inn (Costs 25 gold)",
                        goldCost: 25,
                        diceRoll: true,
                        difficulty: 12,
                        success: () => {
                            gameState.stayedClean = true;
                            gameState.health += 15;
                            return "You rested safely. Avoiding rats and fleas was crucial. You feel refreshed!";
                        },
                        failure: () => {
                            gameState.health -= 15;
                            return "Even the 'clean' inn had rats everywhere. You woke up with flea bites all over your body.";
                        },
                        nextLocation: 4
                    },
                    {
                        text: "Buy medical herbs (Costs 15 gold)",
                        goldCost: 15,
                        diceRoll: true,
                        difficulty: 11,
                        success: () => {
                            gameState.hasHerbs = true;
                            gameState.inventory.push('Medical Herbs');
                            gameState.health += 10;
                            return "Good quality herbs! They help with symptoms and you feel better.";
                        },
                        failure: () => {
                            gameState.health -= 10;
                            return "The 'herbs' were just weeds. They made you feel worse.";
                        },
                        nextLocation: 4
                    },
                    {
                        text: "üí™ Work for a day (Strength check)",
                        diceRoll: true,
                        difficulty: 15,
                        success: () => {
                            const totalGold = 35 + (gameState.strength * 5);
                            gameState.gold += totalGold;
                            return gameState.strength > 0 ? 
                                `You earned ${totalGold} gold! (+${gameState.strength * 5} strength bonus)` :
                                `You earned ${totalGold} gold working safely!`;
                        },
                        failure: () => {
                            const healthLoss = Math.max(25, 40 - gameState.strength * 3);
                            gameState.health -= healthLoss;
                            return `The work was in a plague house clearing bodies! It was exhausting and extremely dangerous. You feel very weak. (Lost ${healthLoss} health)`;
                        },
                        nextLocation: 4
                    },
                    {
                        text: "üíñ Meet Guard Captain Rosa about safe passage (Charisma check)",
                        diceRoll: true,
                        difficulty: 16,
                        success: () => {
                            gameState.peopleTalkedTo++;
                            gameState.health += 15;
                            gameState.hasInfo = true;
                            return "Captain Rosa likes you! She shares which roads are safest and gives you access to clean water wells. Very valuable!";
                        },
                        failure: () => {
                            gameState.peopleTalkedTo++;
                            gameState.gold -= 20;
                            gameState.health -= 15;
                            return "Captain Rosa is suspicious of travelers. She quarantines you in a room with sick people for two days. The room was full of rats and you were bitten by fleas!";
                        },
                        nextLocation: 4
                    },
                    {
                        text: "üõí Visit the merchant's shop",
                        special: 'shop'
                    }
                ]
            },
            {
                name: "Monastery in the Hills",
                text: "A monastery high in the hills. Monks have isolated themselves, trading through a gate window. Very clean‚Äîno rats, they burn herbs constantly.",
                knowledge: "Many monasteries survived better than cities due to isolation and hygiene. Some that helped sick people lost many monks. Religious communities were divided on whether to isolate or help.",
                choices: [
                    {
                        text: "üíñ Ask monks for shelter (Charisma check)",
                        diceRoll: true,
                        difficulty: 17,
                        success: () => {
                            gameState.peopleTalkedTo++;
                            gameState.health += 25;
                            gameState.stayedClean = true;
                            return "The monks let you rest in their guest house for three days. You recover significantly!";
                        },
                        failure: () => {
                            gameState.peopleTalkedTo++;
                            gameState.gold -= 15;
                            gameState.health -= 10;
                            return "The monks refuse entry angrily. They throw rocks and you had to flee through thorny bushes. You're injured.";
                        },
                        nextLocation: 5
                    },
                    {
                        text: "Trade for blessed items (Costs 15 gold)",
                        goldCost: 15,
                        diceRoll: true,
                        difficulty: 13,
                        success: () => {
                            gameState.inventory.push('Blessed Items');
                            gameState.health += 10;
                            return "While these don't stop plague, your confidence makes you more careful!";
                        },
                        failure: () => {
                            gameState.health -= 10;
                            return "The 'blessed' items were fake. Your false confidence led you to take risks.";
                        },
                        nextLocation: 5
                    },
                    {
                        text: "üí™ Chop wood for the monks in exchange for shelter (Strength check)",
                        diceRoll: true,
                        difficulty: 12,
                        success: () => {
                            gameState.health += 20;
                            gameState.stayedClean = true;
                            const bonus = gameState.strength * 5;
                            return gameState.strength > 0 ?
                                `Your strength impressed the monks! They let you stay in their clean guest house. You recovered significantly! (+${bonus} extra health from strength)` :
                                `Hard work but the monks let you rest. You recovered significantly!`;
                        },
                        failure: () => {
                            const healthLoss = Math.max(15, 25 - gameState.strength * 2);
                            gameState.health -= healthLoss;
                            return `The work exhausted you and you had to sleep outside near the stables where rats nested. Fleas bit you. (Lost ${healthLoss} health)`;
                        },
                        nextLocation: 5
                    },
                    {
                        text: "üß† Learn survival methods from monks (Wisdom check)",
                        diceRoll: true,
                        difficulty: 14,
                        success: () => {
                            gameState.cleanedHands = true;
                            gameState.avoidedSickPeople = true;
                            return "The monks teach you about cleanliness and isolation. Valuable survival techniques!";
                        },
                        failure: () => {
                            gameState.health -= 15;
                            return "You couldn't understand their Latin and got frustrated. You left angry and made poor decisions.";
                        },
                        nextLocation: 5
                    },
                    {
                        text: "üçÄ Speak with Brother Marco who tends the sick (Risky)",
                        diceRoll: true,
                        difficulty: 16,
                        success: () => {
                            gameState.peopleTalkedTo++;
                            gameState.helpedOthers++;
                            gameState.hasInfo = true;
                            return "Brother Marco shares from a distance: 'Those who wash constantly and avoid touching the sick live longer.' Valuable!";
                        },
                        failure: () => {
                            gameState.peopleTalkedTo++;
                            gameState.health -= 30;
                            return "Brother Marco is VERY sick with plague. You got too close - he had fleas on his robes that jumped onto you. You were bitten multiple times.";
                        },
                        nextLocation: 5
                    },
                    {
                        text: "üõí Trade with monastery merchant",
                        special: 'shop'
                    }
                ]
            },
            {
                name: "Final Journey - Heading North",
                text: "You've survived this far! You head north to the Alps, where plague is less common. Fresh mountain air, fewer people. But you must cross through one last town...",
                knowledge: "The Black Death changed Europe forever. So many died that workers became scarce, giving common people more power. It led to questioning old ideas and helped spark the Renaissance. Scientists later discovered plague was caused by bacteria spread by fleas, not bad air or punishment.",
                choices: [
                    {
                        text: "üß† Take main road through town (Wisdom check)",
                        diceRoll: true,
                        difficulty: calculateFinalDifficulty() - 1,
                        success: () => {
                            return "SUCCESS!";
                        },
                        failure: () => {
                            gameState.health -= 50;
                            if (gameState.health <= 0) return "FAILURE";
                            return "PARTIAL";
                        },
                        nextLocation: 6
                    },
                    {
                        text: "üí™ Go around through forest (Strength check)",
                        diceRoll: true,
                        difficulty: calculateFinalDifficulty() + 1,
                        success: () => {
                            return "SUCCESS!";
                        },
                        failure: () => {
                            gameState.health -= 35;
                            if (gameState.health <= 0) return "FAILURE";
                            return "PARTIAL";
                        },
                        nextLocation: 6
                    },
                    {
                        text: "üíñ Hire Guide Elena for safe paths (Charisma check - Costs 20 gold)",
                        goldCost: 20,
                        diceRoll: true,
                        difficulty: 15,
                        success: () => {
                            gameState.peopleTalkedTo++;
                            return "Elena is honest! She shows you hidden paths that avoid all sick areas. You reach the mountains safely!\n\nSUCCESS!";
                        },
                        failure: () => {
                            gameState.peopleTalkedTo++;
                            gameState.health -= 45;
                            if (gameState.health <= 0) return "Elena was a fraud! She led you directly into rat-infested plague wards and stole your gold. Fleas bit you everywhere. You collapsed.\n\nFAILURE";
                            return "Elena was a fraud! She led you through rat-infested areas where fleas bit you, and she stole your gold. You barely escaped.\n\nPARTIAL";
                        },
                        nextLocation: 6
                    },
                    {
                        text: "üçÄ Rest here to regain strength first (Risky gamble - Costs 20 gold)",
                        goldCost: 20,
                        diceRoll: true,
                        difficulty: 11,
                        success: () => {
                            gameState.health += 20;
                            return "You feel much better! Ready for the final journey.";
                        },
                        failure: () => {
                            gameState.health -= 15;
                            return "While resting, rats got into your supplies and you got bitten by fleas. You feel worse!";
                        },
                        nextLocation: 5
                    }
                ]
            }
        ];

        function calculateFinalDifficulty() {
            let difficulty = 20; // Much harder base difficulty!
            
            // Bonuses for good choices
            if (gameState.avoidedSickPeople) difficulty -= 2;
            if (gameState.hasMask) difficulty -= 1;
            if (gameState.hasVinegar) difficulty -= 2;
            if (gameState.stayedClean) difficulty -= 2;
            if (gameState.cleanedHands) difficulty -= 2;
            if (gameState.hasInfo) difficulty -= 2;
            if (gameState.hasHerbs) difficulty -= 1;
            if (gameState.health > 90) difficulty -= 2;
            if (gameState.health > 70) difficulty -= 1;
            
            return Math.max(difficulty, 12); // Minimum is much higher
        }

        function showCharacterCreation() {
            const creationHTML = `
                <div class="character-creation">
                    <h2 style="text-align: center; color: #d4af37; margin-bottom: 20px;">Create Your Character</h2>
                    
                    <div class="creation-section">
                        <h3>What is your name, traveler?</h3>
                        <input type="text" id="characterNameInput" class="name-input" placeholder="Enter your character's name..." maxlength="30">
                    </div>

                    <div class="creation-section">
                        <h3>Distribute Your Ability Points</h3>
                        <div class="points-remaining">
                            <div style="font-size: 1.1em; color: #c9a961; margin-bottom: 10px;">Points Remaining</div>
                            <div class="points-remaining-number" id="pointsRemaining">10</div>
                        </div>
                        
                        <div class="stat-allocation">
                            <div class="stat-control">
                                <div class="stat-control-header">
                                    <span class="stat-name">üß† Wisdom</span>
                                    <div class="stat-buttons">
                                        <button class="stat-btn" onclick="decreaseStat('wisdom')">‚àí</button>
                                        <span class="stat-current" id="wisdom-value">0</span>
                                        <button class="stat-btn" onclick="increaseStat('wisdom')">+</button>
                                    </div>
                                </div>
                                <div class="stat-description">
                                    Better choices when avoiding danger. Helps you pass wisdom checks to stay safe.
                                </div>
                            </div>

                            <div class="stat-control">
                                <div class="stat-control-header">
                                    <span class="stat-name">üí™ Strength</span>
                                    <div class="stat-buttons">
                                        <button class="stat-btn" onclick="decreaseStat('strength')">‚àí</button>
                                        <span class="stat-current" id="strength-value">0</span>
                                        <button class="stat-btn" onclick="increaseStat('strength')">+</button>
                                    </div>
                                </div>
                                <div class="stat-description">
                                    Strong body fights sickness better. More starting health and helps you recover.
                                </div>
                            </div>

                            <div class="stat-control">
                                <div class="stat-control-header">
                                    <span class="stat-name">üçÄ Luck</span>
                                    <div class="stat-buttons">
                                        <button class="stat-btn" onclick="decreaseStat('luck')">‚àí</button>
                                        <span class="stat-current" id="luck-value">0</span>
                                        <button class="stat-btn" onclick="increaseStat('luck')">+</button>
                                    </div>
                                </div>
                                <div class="stat-description">
                                    Good fortune! Improves risky dice rolls throughout the journey.
                                </div>
                            </div>

                            <div class="stat-control">
                                <div class="stat-control-header">
                                    <span class="stat-name">üíñ Charisma</span>
                                    <div class="stat-buttons">
                                        <button class="stat-btn" onclick="decreaseStat('charisma')">‚àí</button>
                                        <span class="stat-current" id="charisma-value">0</span>
                                        <button class="stat-btn" onclick="increaseStat('charisma')">+</button>
                                    </div>
                                </div>
                                <div class="stat-description">
                                    Friendly people get better deals and help from others. Earn more gold.
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="start-btn" id="startGameBtn" onclick="startGame()" disabled>
                        ‚öîÔ∏è Begin Your Journey ‚öîÔ∏è
                    </button>
                </div>
            `;

            document.getElementById('storyContent').innerHTML = creationHTML;
            document.getElementById('choicesContainer').innerHTML = '';
            document.getElementById('characterNameInput').addEventListener('input', updateStartButton);
            updateStatButtons();
        }

        function increaseStat(statName) {
            if (creationState.pointsRemaining > 0 && creationState.stats[statName] < 5) {
                creationState.stats[statName]++;
                creationState.pointsRemaining--;
                updateStatDisplay(statName);
                updateStatButtons();
                updateStartButton();
            }
        }

        function decreaseStat(statName) {
            if (creationState.stats[statName] > 0) {
                creationState.stats[statName]--;
                creationState.pointsRemaining++;
                updateStatDisplay(statName);
                updateStatButtons();
                updateStartButton();
            }
        }

        function updateStatDisplay(statName) {
            document.getElementById(`${statName}-value`).textContent = creationState.stats[statName];
            document.getElementById('pointsRemaining').textContent = creationState.pointsRemaining;
        }

        function updateStatButtons() {
            const stats = ['wisdom', 'strength', 'luck', 'charisma'];
            stats.forEach(stat => {
                const increaseBtn = document.querySelector(`#${stat}-value`).parentElement.querySelector('button:last-child');
                const decreaseBtn = document.querySelector(`#${stat}-value`).parentElement.querySelector('button:first-child');
                
                increaseBtn.disabled = creationState.pointsRemaining === 0 || creationState.stats[stat] >= 5;
                decreaseBtn.disabled = creationState.stats[stat] === 0;
            });
        }

        function updateStartButton() {
            const nameInput = document.getElementById('characterNameInput');
            const startBtn = document.getElementById('startGameBtn');
            const hasName = nameInput && nameInput.value.trim().length > 0;
            const hasSpentPoints = creationState.pointsRemaining === 0;
            
            if (startBtn) {
                startBtn.disabled = !hasName || !hasSpentPoints;
                if (!hasName && !hasSpentPoints) {
                    startBtn.textContent = '‚öîÔ∏è Enter Name & Spend All Points ‚öîÔ∏è';
                } else if (!hasName) {
                    startBtn.textContent = '‚öîÔ∏è Enter Your Name First ‚öîÔ∏è';
                } else if (!hasSpentPoints) {
                    startBtn.textContent = `‚öîÔ∏è Spend ${creationState.pointsRemaining} More Points ‚öîÔ∏è`;
                } else {
                    startBtn.textContent = '‚öîÔ∏è Begin Your Journey ‚öîÔ∏è';
                }
            }
        }

        function startGame() {
            const nameInput = document.getElementById('characterNameInput');
            gameState.characterName = nameInput.value.trim();
            
            gameState.wisdom = creationState.stats.wisdom;
            gameState.strength = creationState.stats.strength;
            gameState.luck = creationState.stats.luck;
            gameState.charisma = creationState.stats.charisma;
            
            gameState.maxHealth = 100 + (gameState.strength * 10);
            gameState.health = gameState.maxHealth;
            gameState.gold = 25 + (gameState.charisma * 5);
            gameState.gameStarted = true;
            
            document.getElementById('characterSheet').style.display = 'block';
            updateCharacterSheetWithStats();
            showLocation(0);
        }

        function updateCharacterSheetWithStats() {
            const statsHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <strong style="font-size: 1.3em; color: #d4af37;">${gameState.characterName}</strong>
                </div>
                <div class="stat-row">
                    <div class="stat">
                        <div class="stat-label">Health</div>
                        <div class="stat-value" id="healthValue">${gameState.health}</div>
                        <div class="health-bar">
                            <div class="health-fill" id="healthBar" style="width: 100%">${gameState.health}/${gameState.maxHealth}</div>
                        </div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Gold Coins</div>
                        <div class="stat-value" id="goldValue">${gameState.gold}</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Towns Visited</div>
                        <div class="stat-value" id="townsValue">${gameState.townsVisited}</div>
                    </div>
                </div>
                <div class="stat-row" style="margin-top: 10px;">
                    <div class="stat" style="min-width: 100px;">
                        <div class="stat-label">Wisdom</div>
                        <div class="stat-value">${gameState.wisdom}</div>
                    </div>
                    <div class="stat" style="min-width: 100px;">
                        <div class="stat-label">Strength</div>
                        <div class="stat-value">${gameState.strength}</div>
                    </div>
                    <div class="stat" style="min-width: 100px;">
                        <div class="stat-label">Luck</div>
                        <div class="stat-value">${gameState.luck}</div>
                    </div>
                    <div class="stat" style="min-width: 100px;">
                        <div class="stat-label">Charisma</div>
                        <div class="stat-value">${gameState.charisma}</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <div class="stat-label">Inventory:</div>
                    <div class="inventory" id="inventory">
                        ${gameState.inventory.map(item => `<span class="item">${item}</span>`).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('characterSheet').innerHTML = statsHTML;
        }

        function updateDisplay() {
            document.getElementById('healthValue').textContent = gameState.health;
            document.getElementById('goldValue').textContent = gameState.gold;
            document.getElementById('townsValue').textContent = gameState.townsVisited;
            
            const healthPercent = Math.max(0, Math.round((gameState.health / gameState.maxHealth) * 100));
            document.getElementById('healthBar').style.width = healthPercent + '%';
            document.getElementById('healthBar').textContent = `${gameState.health}/${gameState.maxHealth}`;
            
            // Make inventory items clickable with emojis
            const itemEmojis = {
                'Bread': 'üçû', 'Medicine': 'üß™', 'Ancient Tome': 'üìñ',
                'Training Weights': 'üí™', 'Lucky Charm': 'üçÄ', 'Fine Clothes': 'üëî',
                'Medicine Pouch': 'üíº', 'Herb Mask': 'üò∑', 'Travel Map': 'üó∫Ô∏è',
                'Vinegar': 'üß¥', 'Medical Herbs': 'üåø', 'Blessed Items': '‚úùÔ∏è'
            };
            
            const inventoryEl = document.getElementById('inventory');
            if (gameState.inventory.length === 0) {
                inventoryEl.innerHTML = 'Empty';
            } else {
                inventoryEl.innerHTML = gameState.inventory.map((item, index) => {
                    const emoji = itemEmojis[item] || 'üì¶';
                    return `<span class="item clickable-item" data-item-name="${item}" data-item-index="${index}" title="Click to use or view">${emoji} ${item}</span>`;
                }).join('');
                
                // Add click handlers using event delegation
                inventoryEl.querySelectorAll('.clickable-item').forEach(el => {
                    el.addEventListener('click', function() {
                        const itemName = this.getAttribute('data-item-name');
                        const itemIndex = parseInt(this.getAttribute('data-item-index'));
                        useItem(itemName, itemIndex);
                    });
                });
            }
        }

        function useItem(itemName, itemIndex) {
            const itemEffects = {
                'Bread': { type: 'health', value: 15, consumable: true, emoji: 'üçû', desc: 'Freshly baked bread restores your energy' },
                'Medicine': { type: 'health', value: 25, consumable: true, emoji: 'üß™', desc: 'Medieval herbal medicine that helps recovery' },
                'Ancient Tome': { type: 'stat', stat: 'wisdom', value: 1, consumable: true, emoji: 'üìñ', desc: 'Study this ancient book to gain wisdom' },
                'Training Weights': { type: 'stat', stat: 'strength', value: 1, consumable: true, emoji: 'üí™', desc: 'Train with these to become stronger' },
                'Lucky Charm': { type: 'stat', stat: 'luck', value: 1, consumable: true, emoji: 'üçÄ', desc: 'A magical charm that brings good fortune' },
                'Fine Clothes': { type: 'stat', stat: 'charisma', value: 1, consumable: true, emoji: 'üëî', desc: 'Wearing fine clothes makes you more persuasive' },
                'Medicine Pouch': { type: 'none', emoji: 'üíº', desc: 'Basic supplies for your journey (passive benefit)' },
                'Herb Mask': { type: 'none', emoji: 'üò∑', desc: 'Protects against bad air (passive benefit)' },
                'Travel Map': { type: 'none', emoji: 'üó∫Ô∏è', desc: 'Shows safe routes (passive benefit)' },
                'Vinegar': { type: 'none', emoji: 'üß¥', desc: 'For washing hands (passive benefit)' },
                'Medical Herbs': { type: 'none', emoji: 'üåø', desc: 'Helps with symptoms (passive benefit)' },
                'Blessed Items': { type: 'none', emoji: '‚úùÔ∏è', desc: 'Religious protection (passive benefit)' }
            };

            const item = itemEffects[itemName];
            if (!item) return;

            if (item.type === 'none') {
                showInfoModal(`${item.emoji} ${itemName}`, item.desc);
                return;
            }

            let effectText = '';
            if (item.type === 'health') {
                const potentialHealing = Math.min(item.value, gameState.maxHealth - gameState.health);
                if (potentialHealing <= 0) {
                    showInfoModal(`${item.emoji} ${itemName}`, "You're already at full health! Save this for when you're injured.");
                    return;
                }
                effectText = `${item.desc}<br><br><strong>Effect:</strong> Restore ${item.value} health<br>Current: ${gameState.health}/${gameState.maxHealth}`;
            } else if (item.type === 'stat') {
                effectText = `${item.desc}<br><br><strong>Effect:</strong> Permanently +1 ${item.stat}<br>Current ${item.stat}: ${gameState[item.stat]}`;
            }

            const confirmHTML = `
                <div class="outcome-modal">
                    <div class="outcome-content">
                        <div class="outcome-header">${item.emoji} Use ${itemName}?</div>
                        <div class="outcome-text" style="text-align: center;">
                            ${effectText}
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="continue-btn" onclick="confirmUseItem('${itemName}', ${itemIndex})" style="flex: 1;">‚úì Use Item</button>
                            <button class="continue-btn" onclick="closeModal()" style="flex: 1; background: #8B4513;">‚úó Cancel</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('outcomeModal').innerHTML = confirmHTML;
            document.getElementById('outcomeModal').style.display = 'flex';
        }

        function confirmUseItem(itemName, itemIndex) {
            const itemEffects = {
                'Bread': { type: 'health', value: 15 },
                'Medicine': { type: 'health', value: 25 },
                'Ancient Tome': { type: 'stat', stat: 'wisdom', value: 1 },
                'Training Weights': { type: 'stat', stat: 'strength', value: 1 },
                'Lucky Charm': { type: 'stat', stat: 'luck', value: 1 },
                'Fine Clothes': { type: 'stat', stat: 'charisma', value: 1 }
            };

            const item = itemEffects[itemName];
            let resultText = '';

            if (item.type === 'health') {
                const oldHealth = gameState.health;
                gameState.health = Math.min(gameState.maxHealth, gameState.health + item.value);
                const actualHealing = gameState.health - oldHealth;
                resultText = `You ate the ${itemName} and restored ${actualHealing} health!<br>Health: ${gameState.health}/${gameState.maxHealth}`;
            } else if (item.type === 'stat') {
                gameState[item.stat] += item.value;
                resultText = `You used ${itemName} and permanently gained +${item.value} ${item.stat}!<br>New ${item.stat}: ${gameState[item.stat]}`;
                updateCharacterSheetWithStats();
            }

            gameState.inventory.splice(itemIndex, 1);
            updateDisplay();
            showInfoModal("‚úì Item Used Successfully!", resultText);
        }

        function showInfoModal(title, message) {
            const modalHTML = `
                <div class="outcome-modal">
                    <div class="outcome-content">
                        <div class="outcome-header">${title}</div>
                        <div class="outcome-text" style="text-align: center;">${message}</div>
                        <button class="continue-btn" onclick="closeModal()">Continue ‚Üí</button>
                    </div>
                </div>
            `;
            document.getElementById('outcomeModal').innerHTML = modalHTML;
            document.getElementById('outcomeModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('outcomeModal').style.display = 'none';
        }

        function showShop(returnLocation) {
            const currentLoc = returnLocation; // Store for use in template
            const shopItems = [
                { name: 'Bread', cost: 15, emoji: 'üçû', desc: '+15 health' },
                { name: 'Medicine', cost: 40, emoji: 'üß™', desc: '+25 health' },
                { name: 'Ancient Tome', cost: 60, emoji: 'üìñ', desc: '+1 Wisdom permanently' },
                { name: 'Training Weights', cost: 60, emoji: 'üí™', desc: '+1 Strength permanently' },
                { name: 'Lucky Charm', cost: 55, emoji: 'üçÄ', desc: '+1 Luck permanently' },
                { name: 'Fine Clothes', cost: 55, emoji: 'üëî', desc: '+1 Charisma permanently' }
            ];

            const shopHTML = `
                <div class="outcome-modal">
                    <div class="outcome-content" style="max-width: 600px;">
                        <div class="outcome-header">üõí Merchant's Shop</div>
                        <div class="outcome-text" style="text-align: left;">
                            <strong>Your Gold: <span id="shop-gold">${gameState.gold}</span></strong><br><br>
                            ${shopItems.map(item => {
                                const canAfford = gameState.gold >= item.cost;
                                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(80,60,40,0.5); border-radius: 5px; ${canAfford ? 'cursor: pointer; border: 2px solid #d4af37;' : 'opacity: 0.5; border: 2px solid #555;'}" ${canAfford ? `onclick="buyItemInShop('${item.name}', ${item.cost}, ${currentLoc})"` : ''}>
                                    <span>${item.emoji} <strong>${item.name}</strong> - ${item.desc}</span>
                                    <span style="color: #d4af37; font-weight: bold;">${item.cost} gold</span>
                                </div>`;
                            }).join('')}
                        </div>
                        <button class="continue-btn" onclick="leaveShop(${currentLoc})" style="margin-top: 15px;">Leave Shop ‚Üí</button>
                    </div>
                </div>
            `;

            document.getElementById('outcomeModal').innerHTML = shopHTML;
            document.getElementById('outcomeModal').style.display = 'flex';
        }

        function buyItemInShop(itemName, cost, returnLocation) {
            // Double-check we have enough gold (safeguard against race conditions)
            if (gameState.gold < cost) {
                console.log("Not enough gold!");
                return;
            }

            gameState.gold -= cost;
            gameState.inventory.push(itemName);
            updateDisplay();

            // Update shop display immediately
            const shopGoldEl = document.getElementById('shop-gold');
            if (shopGoldEl) {
                shopGoldEl.textContent = gameState.gold;
            }
            
            // Show brief confirmation
            const itemEmojis = {
                'Bread': 'üçû', 'Medicine': 'üß™', 'Ancient Tome': 'üìñ',
                'Training Weights': 'üí™', 'Lucky Charm': 'üçÄ', 'Fine Clothes': 'üëî'
            };
            
            const confirmDiv = document.createElement('div');
            confirmDiv.style = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: #d4af37; padding: 20px 40px; border: 2px solid #d4af37; border-radius: 10px; z-index: 10000; font-size: 1.2em;';
            confirmDiv.textContent = `‚úì Purchased ${itemEmojis[itemName]} ${itemName}!`;
            document.body.appendChild(confirmDiv);
            
            setTimeout(() => {
                if (document.body.contains(confirmDiv)) {
                    document.body.removeChild(confirmDiv);
                }
                showShop(returnLocation); // Refresh shop with same return location
            }, 600);
        }

        function leaveShop(returnLocation) {
            closeModal();
            refreshLocation(returnLocation); // Return to same location without incrementing counter
        }

        function buyItem(itemName, cost) {
            // Legacy function - redirect to new one
            buyItemInShop(itemName, cost);
        }

        function showLocation(locationIndex) {
            if (gameState.health <= 0) {
                showGameOver(false);
                return;
            }

            if (locationIndex >= storyPath.length) {
                showGameOver(true);
                return;
            }

            const location = storyPath[locationIndex];
            gameState.currentLocation = locationIndex;
            gameState.townsVisited++;

            displayLocation(location);
        }

        function refreshLocation(locationIndex) {
            // Show location without incrementing townsVisited (for returning from shop)
            if (gameState.health <= 0) {
                showGameOver(false);
                return;
            }

            if (locationIndex >= storyPath.length) {
                showGameOver(true);
                return;
            }

            const location = storyPath[locationIndex];
            gameState.currentLocation = locationIndex;
            
            displayLocation(location);
        }

        function displayLocation(location) {
            let storyHTML = `
                <div class="location-header">${location.name}</div>
                <p>${location.text}</p>
            `;

            if (location.knowledge) {
                storyHTML += `
                    <div class="knowledge-box">
                        <h3>üìú Historical Knowledge</h3>
                        <p>${location.knowledge}</p>
                    </div>
                `;
            }

            document.getElementById('storyContent').innerHTML = storyHTML;
            showChoices(location.choices);
            updateDisplay();
        }

        function showChoices(choices) {
            const container = document.getElementById('choicesContainer');
            container.innerHTML = '';

            choices.forEach((choice) => {
                const button = document.createElement('button');
                button.className = 'choice-btn';
                
                let buttonText = choice.text;
                
                if (choice.goldCost && gameState.charisma > 0) {
                    const discount = Math.min(gameState.charisma * 2, choice.goldCost * 0.4);
                    const actualCost = Math.max(Math.round(choice.goldCost - discount), 1);
                    
                    if (actualCost < choice.goldCost) {
                        buttonText = buttonText.replace(`Costs ${choice.goldCost} gold`, 
                            `Costs ${actualCost} gold (${choice.goldCost} - ${Math.round(discount)} charisma)`);
                    }
                    
                    if (gameState.gold < actualCost) {
                        button.disabled = true;
                        buttonText += ' [Not enough gold]';
                    }
                } else if (choice.goldCost && gameState.gold < choice.goldCost) {
                    button.disabled = true;
                    buttonText += ' [Not enough gold]';
                }
                
                button.textContent = buttonText;
                button.onclick = () => handleChoice(choice);
                container.appendChild(button);
            });
        }

        function handleChoice(choice) {
            let actualCost = choice.goldCost || 0;
            if (actualCost > 0 && gameState.charisma > 0) {
                const discount = Math.min(gameState.charisma * 2, actualCost * 0.4);
                actualCost = Math.max(Math.round(actualCost - discount), 1);
            }

            if (actualCost > 0) {
                gameState.gold -= actualCost;
            }

            if (choice.diceRoll) {
                // Show "Roll the Dice" button modal
                showRollDicePrompt(choice);
            } else if (choice.special === 'shop') {
                // Special case for shop - open it and return to current location
                showShop(gameState.currentLocation);
            } else if (choice.immediate) {
                const message = choice.effect();
                // Check if player died from this choice
                if (gameState.health <= 0) {
                    showOutcomeModal("üíÄ Critical Injury!", message + "\n\nYou collapsed...", () => showGameOver(false));
                } else {
                    showOutcomeModal("Outcome", message, () => showTransition(choice.nextLocation));
                }
            } else {
                if (choice.effect) {
                    const message = choice.effect();
                    // Check if player died from this choice
                    if (gameState.health <= 0) {
                        showOutcomeModal("üíÄ Critical Injury!", message + "\n\nYou collapsed...", () => showGameOver(false));
                    } else {
                        showOutcomeModal("Outcome", message, () => showTransition(choice.nextLocation));
                    }
                } else {
                    showTransition(choice.nextLocation);
                }
            }

            updateDisplay();
        }

        function showRollDicePrompt(choice) {
            // Apply low health penalty to difficulty
            let adjustedDifficulty = choice.difficulty;
            let difficultyWarning = '';
            
            if (gameState.health < 30) {
                adjustedDifficulty += 3;
                difficultyWarning = '<br><span style="color: #e63946;">‚ö†Ô∏è You are badly weakened! (+3 difficulty)</span>';
            } else if (gameState.health < 50) {
                adjustedDifficulty += 2;
                difficultyWarning = '<br><span style="color: #f4a261;">‚ö†Ô∏è You are weakened! (+2 difficulty)</span>';
            } else if (gameState.health < 70) {
                adjustedDifficulty += 1;
                difficultyWarning = '<br><span style="color: #e9c46a;">‚ö†Ô∏è You feel unwell. (+1 difficulty)</span>';
            }
            
            const modalHTML = `
                <div class="outcome-modal">
                    <div class="outcome-content">
                        <div class="outcome-header">üé≤ Time to Roll! üé≤</div>
                        <div class="outcome-text" style="text-align: center;">
                            You've made your choice. Now let fate decide...<br><br>
                            <strong>Difficulty: ${adjustedDifficulty}+</strong>
                            ${difficultyWarning}
                            ${gameState.wisdom > 0 || gameState.luck > 0 ? 
                                `<br><span style="color: #d4af37;">You'll get bonuses from your stats!</span>` : 
                                ''}
                        </div>
                        <button class="continue-btn" onclick="executeRoll()">üé≤ Roll the Dice! üé≤</button>
                    </div>
                </div>
            `;

            const modalContainer = document.getElementById('outcomeModal');
            modalContainer.innerHTML = modalHTML;
            modalContainer.style.display = 'flex';

            // Store the adjusted difficulty with the choice
            choice.adjustedDifficulty = adjustedDifficulty;
            window.currentChoice = choice;
        }

        function executeRoll() {
            const choice = window.currentChoice;
            
            // Show rolling animation
            showRollingAnimation(choice);
        }

        function showRollingAnimation(choice) {
            const modalHTML = `
                <div class="outcome-modal">
                    <div class="outcome-content">
                        <div class="outcome-header">üé≤ Rolling... üé≤</div>
                        <div class="dice-rolling-container">
                            <div class="dice-spinner">üé≤</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="rollProgressBar"></div>
                        </div>
                        <div class="outcome-text" style="text-align: center; margin-top: 20px;">
                            Fate is deciding your future...
                        </div>
                    </div>
                </div>
            `;

            const modalContainer = document.getElementById('outcomeModal');
            modalContainer.innerHTML = modalHTML;
            modalContainer.style.display = 'flex';

            // Start progress bar animation
            const progressBar = document.getElementById('rollProgressBar');
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    // After animation, show the result
                    setTimeout(() => {
                        rollDice(choice);
                    }, 200);
                } else {
                    width += 5;
                    progressBar.style.width = width + '%';
                }
            }, 50); // 2 seconds total (100% / 5 per step * 50ms = 2000ms)
        }

        function rollDice(choice) {
            const baseRoll = Math.floor(Math.random() * 20) + 1;
            let totalRoll = baseRoll;
            let bonusText = '';
            
            // Use adjusted difficulty if low health penalty was applied
            const difficulty = choice.adjustedDifficulty || choice.difficulty;
            
            if (difficulty) {
                // Only apply the relevant stat bonus based on check type
                // Check the choice text to determine what type of check it is
                const choiceText = choice.text.toLowerCase();
                
                if (choiceText.includes('wisdom check') && gameState.wisdom > 0) {
                    totalRoll += gameState.wisdom;
                    bonusText += ` +${gameState.wisdom} Wisdom`;
                } else if (choiceText.includes('strength check') && gameState.strength > 0) {
                    totalRoll += gameState.strength;
                    bonusText += ` +${gameState.strength} Strength`;
                } else if (choiceText.includes('charisma check') && gameState.charisma > 0) {
                    totalRoll += gameState.charisma;
                    bonusText += ` +${gameState.charisma} Charisma`;
                } else if ((choiceText.includes('health check') || choiceText.includes('risky') || choiceText.includes('gamble')) && gameState.luck > 0) {
                    // Risky choices benefit from luck
                    totalRoll += gameState.luck;
                    bonusText += ` +${gameState.luck} Luck`;
                }
                // If no specific check type mentioned, no bonus applied
            }
            
            const success = totalRoll >= difficulty;
            let resultMessage;
            
            if (success) {
                resultMessage = choice.success ? choice.success() : "Success!";
            } else {
                resultMessage = choice.failure ? choice.failure() : "Failed...";
                
                // Apply extra damage if health is very low (wounded and failing makes things worse)
                if (gameState.health < 40 && !resultMessage.includes("FAILURE")) {
                    const extraDamage = Math.floor(Math.random() * 10) + 5;
                    gameState.health -= extraDamage;
                    resultMessage += `\n\nYour weakened body couldn't handle this setback. (-${extraDamage} additional health)`;
                }
            }

            const rollDisplay = baseRoll === totalRoll ? 
                `You rolled a ${baseRoll}!` : 
                `You rolled a ${baseRoll}${bonusText} = ${totalRoll}!`;

            const fullMessage = `${rollDisplay}\n(Needed ${difficulty}+)\n\n${resultMessage}`;

            // Check if player died from this roll
            if (gameState.health <= 0 && !resultMessage.includes("SUCCESS!")) {
                showOutcomeModal(
                    "üíÄ You Have Died!",
                    fullMessage + "\n\nüíÄ Your journey ends here... üíÄ",
                    () => showGameOver(false),
                    totalRoll
                );
                return;
            }

            showOutcomeModal(
                success ? "üé≤ Success!" : "üé≤ Failed!",
                fullMessage,
                () => {
                    if (choice.nextLocation === 6) {
                        // Final location - check for special endings
                        if (resultMessage.includes("SUCCESS!")) {
                            showGameOver(true);
                        } else if (resultMessage.includes("PARTIAL")) {
                            showPartialVictory();
                        } else if (gameState.health <= 0 || resultMessage.includes("FAILURE")) {
                            showGameOver(false);
                        } else {
                            showGameOver(true);
                        }
                    } else if (gameState.health <= 0) {
                        showGameOver(false);
                    } else {
                        showTransition(choice.nextLocation);
                    }
                },
                totalRoll
            );
        }

        // NEW: Transition screen between locations
        function showTransition(nextLocation) {
            if (nextLocation >= storyPath.length) {
                showGameOver(true);
                return;
            }

            const nextLocationData = storyPath[nextLocation];
            
            // Show health warning if critical
            let healthWarning = '';
            let healthColor = '#d4af37';
            
            if (gameState.health <= 20) {
                healthWarning = '<br><span style="color: #e63946; font-size: 1.1em;">‚ö†Ô∏è CRITICAL CONDITION! ‚ö†Ô∏è</span>';
                healthColor = '#e63946';
            } else if (gameState.health <= 40) {
                healthWarning = '<br><span style="color: #f4a261;">‚ö†Ô∏è Badly injured!</span>';
                healthColor = '#f4a261';
            } else if (gameState.health <= 60) {
                healthWarning = '<br><span style="color: #e9c46a;">‚ö†Ô∏è Wounded</span>';
                healthColor = '#e9c46a';
            }
            
            const transitionHTML = `
                <div class="outcome-modal">
                    <div class="outcome-content">
                        <div class="outcome-header">üìç Journey Continues...</div>
                        <div class="outcome-text" style="text-align: center; font-size: 1.3em;">
                            <strong style="color: #d4af37;">Next Stop:</strong><br><br>
                            ${nextLocationData.name}
                            <br><br>
                            <span style="font-size: 0.9em; color: #c9a961;">
                                <span style="color: ${healthColor};">Health: ${gameState.health}/${gameState.maxHealth}</span><br>
                                Gold: ${gameState.gold}
                            </span>
                            ${healthWarning}
                        </div>
                        <button class="continue-btn" onclick="proceedToLocation(${nextLocation})">Continue Journey ‚Üí</button>
                    </div>
                </div>
            `;

            const modalContainer = document.getElementById('outcomeModal');
            modalContainer.innerHTML = transitionHTML;
            modalContainer.style.display = 'flex';
        }

        function proceedToLocation(locationIndex) {
            document.getElementById('outcomeModal').style.display = 'none';
            showLocation(locationIndex);
        }

        // NEW: Outcome Modal with Continue Button
        function showOutcomeModal(title, message, callback, diceRoll = null) {
            const modalHTML = `
                <div class="outcome-modal">
                    <div class="outcome-content">
                        <div class="outcome-header">${title}</div>
                        ${diceRoll ? `<div class="dice-result">üé≤ ${diceRoll}</div>` : ''}
                        <div class="outcome-text">${message.replace(/\n/g, '<br>')}</div>
                        <button class="continue-btn" onclick="closeOutcomeModal()">Continue ‚Üí</button>
                    </div>
                </div>
            `;

            const modalContainer = document.getElementById('outcomeModal');
            modalContainer.innerHTML = modalHTML;
            modalContainer.style.display = 'flex';

            window.currentCallback = callback;
        }

        function closeOutcomeModal() {
            document.getElementById('outcomeModal').style.display = 'none';
            if (window.currentCallback) {
                window.currentCallback();
                window.currentCallback = null;
            }
            updateDisplay();
        }

        function showPartialVictory() {
            const gameOverHTML = `
                <div class="game-over">
                    <h2>üíÄ You Have Died üíÄ</h2>
                    <p style="font-size: 1.2em; line-height: 1.8; margin: 20px 0;">
                        ${gameState.characterName}, you nearly made it to the mountains, but caught the plague on the final leg of your journey.
                        <br><br>
                        Despite your best efforts, the Black Death claimed you. Your body couldn't fight off the infection. 
                        You traveled through ${gameState.townsVisited} locations and learned much about survival, but in the end, 
                        the plague was too deadly.
                        <br><br>
                        The Black Death killed about 1/3 of all Europeans. Even people who made good choices often died. 
                        You experienced the harsh reality of medieval medicine‚Äîthere was no cure.
                    </p>
                    <div class="knowledge-box">
                        <h3>üìä ${gameState.characterName}'s Final Score: ${calculateScore(false)}</h3>
                        <p>
                            Towns Visited: ${gameState.townsVisited} √ó 20 = ${gameState.townsVisited * 20}<br>
                            Gold Remaining: ${gameState.gold}<br>
                            People Helped: ${gameState.helpedOthers} √ó 10 = ${gameState.helpedOthers * 10}<br>
                            Character Stats: ${gameState.wisdom + gameState.strength + gameState.luck + gameState.charisma} √ó 5 = ${(gameState.wisdom + gameState.strength + gameState.luck + gameState.charisma) * 5}<br>
                            Survival Bonus: 0 (died from plague)
                        </p>
                    </div>
                    <button class="restart-btn" onclick="location.reload()">üîÑ Try Again</button>
                </div>
            `;

            document.getElementById('storyContent').innerHTML = gameOverHTML;
            document.getElementById('choicesContainer').innerHTML = '';
        }

        function calculateScore(survived) {
            const survivalBonus = survived ? 50 : 0;
            const helpBonus = gameState.helpedOthers * 10;
            const talkBonus = gameState.peopleTalkedTo * 5;
            return gameState.health + gameState.gold + (gameState.townsVisited * 20) + survivalBonus + helpBonus + talkBonus;
        }

        function showGameOver(survived) {
            const finalScore = calculateScore(survived);

            let message, endText;
            
            if (survived) {
                message = "üéâ YOU SURVIVED! üéâ";
                endText = `Congratulations, ${gameState.characterName}! You survived the Black Death! You made smart choices to stay safe. You ended with ${gameState.health} health and ${gameState.gold} gold.<br><br>Avoiding crowds, staying clean, and being careful around rats increased survival chances. Medieval people didn't know about germs, but those who did these things were more likely to survive.<br><br>You were one of the lucky ones who lived when millions died.`;
            } else {
                message = "üíÄ Journey's End üíÄ";
                endText = `${gameState.characterName}, you did not survive the plague.<br><br>The Black Death was incredibly deadly. Even people who made good choices sometimes got sick and died. Remember: About 1/3 of all Europeans died during this pandemic. You experienced what millions faced during one of history's worst pandemics.<br><br>Medieval doctors had no antibiotics or understanding of bacteria. Once infected, survival was mostly luck.`;
            }

            const gameOverHTML = `
                <div class="game-over">
                    <h2>${message}</h2>
                    <p style="font-size: 1.2em; line-height: 1.8; margin: 20px 0;">${endText}</p>
                    <div class="knowledge-box">
                        <h3>üìä ${gameState.characterName}'s Final Score: ${finalScore}</h3>
                        <p>
                            Health Remaining: ${gameState.health}<br>
                            Gold Remaining: ${gameState.gold}<br>
                            Towns Visited: ${gameState.townsVisited} √ó 20 = ${gameState.townsVisited * 20}<br>
                            People Helped: ${gameState.helpedOthers} √ó 10 = ${gameState.helpedOthers * 10}<br>
                            People Talked To: ${gameState.peopleTalkedTo} √ó 5 = ${gameState.peopleTalkedTo * 5}<br>
                            Survival Bonus: ${survived ? 50 : 0}
                        </p>
                    </div>
                    <button class="restart-btn" onclick="location.reload()">üîÑ ${survived ? 'Play Again' : 'Try Again'}</button>
                </div>
            `;

            document.getElementById('storyContent').innerHTML = gameOverHTML;
            document.getElementById('choicesContainer').innerHTML = '';
        }

        // Start the game
        showCharacterCreation();
    </script>
</body>
</html>
